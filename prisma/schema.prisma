generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model asset_revisions {
  id              String   @id
  asset_id        String
  manifest_json   Json
  walrus_root_uri String
  created_at      DateTime @default(now())
  assets          assets   @relation(fields: [asset_id], references: [id], onDelete: Cascade)

  @@index([asset_id])
}

model assets {
  id              String            @id
  creator_id      String
  title           String
  status          String            @default("uploading")
  created_at      DateTime          @default(now())
  updated_at      DateTime
  asset_revisions asset_revisions[]

  @@index([created_at])
  @@index([creator_id])
  @@index([status])
}

model playback_logs {
  id         String   @id
  session_id String
  video_id   String
  seg_idx    Int
  rendition  String
  timestamp  DateTime @default(now())
  ip         String?
  user_agent String?

  @@index([session_id])
  @@index([timestamp])
  @@index([video_id])
}

model PlaybackSession {
  id           String   @id @default(cuid())
  cookieValue  String   @unique @map("cookie_value")
  videoId      String   @map("video_id")
  clientPubKey Bytes    @map("client_pub_key")
  serverPubKey Bytes    @map("server_pub_key")
  serverNonce  Bytes    @map("server_nonce")
  deviceHash   String?  @map("device_hash")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  lastActivity DateTime @default(now()) @map("last_activity")
  video        Video    @relation("VideoToPlaybackSession", fields: [videoId], references: [id], onDelete: Cascade)

  @@index([cookieValue])
  @@index([expiresAt])
  @@index([videoId])
  @@map("playback_sessions")
}

model VideoRendition {
  id                String         @id @default(cuid())
  videoId           String         @map("video_id")
  name              String
  walrusPlaylistUri String         @map("walrus_playlist_uri")
  resolution        String
  bitrate           Int
  video             Video          @relation("VideoToVideoRendition", fields: [videoId], references: [id], onDelete: Cascade)
  segments          VideoSegment[] @relation("VideoRenditionToVideoSegment")

  @@unique([videoId, name])
  @@map("video_renditions")
}

model VideoSegment {
  id          String         @id @default(cuid())
  renditionId String         @map("rendition_id")
  segIdx      Int            @map("seg_idx")
  walrusUri   String         @map("walrus_uri")
  iv          Bytes
  duration    Float
  size        Int
  dekEnc      Bytes          @map("dek_enc")
  rendition   VideoRendition @relation("VideoRenditionToVideoSegment", fields: [renditionId], references: [id], onDelete: Cascade)

  @@unique([renditionId, segIdx])
  @@index([renditionId])
  @@map("video_segments")
}

model Video {
  id              String            @id @default(cuid())
  title           String
  walrusMasterUri String            @map("walrus_master_uri")
  posterWalrusUri String?           @map("poster_walrus_uri")
  duration        Float?
  network         String            @default("mainnet") // Walrus network: "mainnet" or "testnet"
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  creatorId       String            @map("creator_id")
  sessions        PlaybackSession[] @relation("VideoToPlaybackSession")
  renditions      VideoRendition[]  @relation("VideoToVideoRendition")

  @@index([creatorId])
  @@map("videos")
}
