generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AssetRevision {
  id            String   @id
  assetId       String   @map("asset_id")
  manifestJson  Json     @map("manifest_json")
  walrusRootUri String   @map("walrus_root_uri")
  createdAt     DateTime @default(now()) @map("created_at")
  asset         Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@map("asset_revisions")
}

model Asset {
  id        String          @id
  creatorId String          @map("creator_id")
  title     String
  status    String          @default("uploading")
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  revisions AssetRevision[]

  @@index([createdAt])
  @@index([creatorId])
  @@index([status])
  @@map("assets")
}

model PlaybackLog {
  id        String   @id
  sessionId String   @map("session_id")
  videoId   String   @map("video_id")
  segIdx    Int      @map("seg_idx")
  rendition String
  timestamp DateTime @default(now())
  ip        String?
  userAgent String?  @map("user_agent")

  @@index([sessionId])
  @@index([timestamp])
  @@index([videoId])
  @@map("playback_logs")
}

model PlaybackSession {
  id           String   @id @default(cuid())
  cookieValue  String   @unique @map("cookie_value")
  videoId      String   @map("video_id")
  clientPubKey Bytes    @map("client_pub_key")
  serverPubKey Bytes    @map("server_pub_key")
  serverNonce  Bytes    @map("server_nonce")
  deviceHash   String?  @map("device_hash")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  lastActivity DateTime @default(now()) @map("last_activity")
  video        Video    @relation("VideoToPlaybackSession", fields: [videoId], references: [id], onDelete: Cascade)

  @@index([cookieValue])
  @@index([expiresAt])
  @@index([videoId])
  @@map("playback_sessions")
}

model VideoRendition {
  id                     String         @id @default(cuid())
  videoId                String         @map("video_id")
  name                   String
  walrusPlaylistUri      String         @map("walrus_playlist_uri")
  playlistBlobObjectId   String?        @map("playlist_blob_object_id") // Sui blob object ID (mainnet only)
  playlistEndEpoch       Int?           @map("playlist_end_epoch") // Walrus storage expiry epoch (mainnet only)
  resolution             String
  bitrate                Int

  // SEAL encryption fields (for subscription-acl and "both" encryption)
  sealPlaylistBlobId     String?        @map("seal_playlist_blob_id") // Walrus blob ID for SEAL-encrypted playlist
  sealPlaylistObjectId   String?        @map("seal_playlist_object_id") // Sui blob object ID for SEAL playlist

  video                  Video          @relation("VideoToVideoRendition", fields: [videoId], references: [id], onDelete: Cascade)
  segments               VideoSegment[] @relation("VideoRenditionToVideoSegment")

  @@unique([videoId, name])
  @@index([playlistBlobObjectId])
  @@map("video_renditions")
}

model VideoSegment {
  id           String         @id @default(cuid())
  renditionId  String         @map("rendition_id")
  segIdx       Int            @map("seg_idx")
  walrusUri    String         @map("walrus_uri")
  blobObjectId String?        @map("blob_object_id") // Sui blob object ID (mainnet only)
  endEpoch     Int?           @map("end_epoch") // Walrus storage expiry epoch (mainnet only)
  iv           Bytes
  duration     Float
  size         Int
  dekEnc       Bytes          @map("dek_enc")

  // SEAL encryption fields (for subscription-acl and "both" encryption)
  sealDocumentId String?      @map("seal_document_id") // SEAL document ID for this segment
  sealBlobId     String?      @map("seal_blob_id") // Walrus blob ID for SEAL-encrypted segment

  rendition    VideoRendition @relation("VideoRenditionToVideoSegment", fields: [renditionId], references: [id], onDelete: Cascade)

  @@unique([renditionId, segIdx])
  @@index([renditionId])
  @@index([blobObjectId])
  @@map("video_segments")
}

model CreatorConfig {
  id           String   @id @default(cuid())
  videoId      String   @map("video_id")
  objectId     String   @map("object_id") // On-chain creator config object ID
  chain        String   // Blockchain: "iota", "sui", etc.
  coinType     String   @map("coin_type") // Coin type (e.g., "0x2::sui::SUI")
  pricePerView String   @map("price_per_view") // Raw price per single view (in smallest unit with decimals)
  decimals     Int      // Coin decimals for display/calculation
  metadata     String?  // Optional metadata about this config
  createdAt    DateTime @default(now()) @map("created_at")
  video        Video    @relation("VideoToCreatorConfig", fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, coinType]) // One config per coin type per video
  @@index([videoId])
  @@index([objectId])
  @@index([chain])
  @@map("creator_configs")
}

model Video {
  id                   String            @id @default(cuid())
  title                String
  walrusMasterUri      String            @map("walrus_master_uri")
  masterBlobObjectId   String?           @map("master_blob_object_id") // Sui blob object ID for master playlist (mainnet only)
  masterEndEpoch       Int?              @map("master_end_epoch") // Walrus storage expiry epoch for master (mainnet only)
  posterWalrusUri      String?           @map("poster_walrus_uri")
  posterBlobObjectId   String?           @map("poster_blob_object_id") // Sui blob object ID for poster (mainnet only)
  posterEndEpoch       Int?              @map("poster_end_epoch") // Walrus storage expiry epoch for poster (mainnet only)
  duration             Float?
  network              String            @default("mainnet") // Walrus network: "mainnet" or "testnet"
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  creatorId            String            @map("creator_id")

  // Encryption type: "per-video" (pay per video) or "subscription-acl" (subscribers only) or "both"
  encryptionType       String            @default("per-video") @map("encryption_type")

  // SEAL encryption fields (for subscription-acl and "both" encryption)
  sealObjectId         String?           @map("seal_object_id") // SEAL channel/apology object ID
  sealMasterBlobId     String?           @map("seal_master_blob_id") // Walrus blob ID for SEAL-encrypted master playlist
  sealPosterBlobId     String?           @map("seal_poster_blob_id") // Walrus blob ID for SEAL-encrypted poster

  sessions             PlaybackSession[] @relation("VideoToPlaybackSession")
  renditions           VideoRendition[]  @relation("VideoToVideoRendition")
  creatorConfigs       CreatorConfig[]   @relation("VideoToCreatorConfig")

  @@index([creatorId])
  @@index([masterBlobObjectId])
  @@index([masterEndEpoch])
  @@index([encryptionType])
  @@map("videos")
}

model VideoPaymentInfo {
  id        String   @id @default(cuid())
  videoId   String   @map("video_id")
  payerAddress String   @map("payer_address")
  chain String   @map("chain")
  tunnelObjectId String?   @map("tunnel_object_id")
  maxAllowedPayAmount String?   @map("max_allowed_pay_amount")
  currentPayAmount String?   @map("current_pay_amount")
  authorizeSignature String?   @map("authorize_signature")
  paidSegmentIds  Int[] @map("paid_segment_ids")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([videoId])
  @@map("video_payment_infos")
}

model Creator {
  id            String   @id @default(cuid())
  walletAddress String   @unique @map("wallet_address")
  name          String
  bio           String?
  avatar        String?  // Walrus blob ID or URL for avatar image
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Channel subscription settings
  channelPrice  String?  @map("channel_price") // Subscription price (one-time payment)
  channelChain  String?  @map("channel_chain") // "sui" or "iota"
  channelCoinType String? @map("channel_coin_type") // Coin type for subscriptions
  sealObjectId  String?  @map("seal_object_id") // SEAL channel object ID for ACL

  subscriptions Subscription[] @relation("CreatorToSubscriptions")

  @@index([walletAddress])
  @@map("creators")
}

model Subscription {
  id                String   @id @default(cuid())
  subscriberAddress String   @map("subscriber_address")
  creatorId         String   @map("creator_id")
  chain             String   // "sui" or "iota"
  txDigest          String   @map("tx_digest") // Payment transaction digest
  createdAt         DateTime @default(now()) @map("created_at")

  creator           Creator  @relation("CreatorToSubscriptions", fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([subscriberAddress, creatorId, chain])
  @@index([creatorId])
  @@index([subscriberAddress])
  @@map("subscriptions")
}