generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AssetRevision {
  id            String   @id
  assetId       String   @map("asset_id")
  manifestJson  Json     @map("manifest_json")
  walrusRootUri String   @map("walrus_root_uri")
  createdAt     DateTime @default(now()) @map("created_at")
  asset         Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@map("asset_revisions")
}

model Asset {
  id        String          @id
  creatorId String          @map("creator_id")
  title     String
  status    String          @default("uploading")
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  revisions AssetRevision[]

  @@index([createdAt])
  @@index([creatorId])
  @@index([status])
  @@map("assets")
}

model PlaybackLog {
  id        String   @id
  sessionId String   @map("session_id")
  videoId   String   @map("video_id")
  segIdx    Int      @map("seg_idx")
  rendition String
  timestamp DateTime @default(now())
  ip        String?
  userAgent String?  @map("user_agent")

  @@index([sessionId])
  @@index([timestamp])
  @@index([videoId])
  @@map("playback_logs")
}

model PlaybackSession {
  id           String   @id @default(cuid())
  cookieValue  String   @unique @map("cookie_value")
  videoId      String   @map("video_id")
  clientPubKey Bytes    @map("client_pub_key")
  serverPubKey Bytes    @map("server_pub_key")
  serverNonce  Bytes    @map("server_nonce")
  deviceHash   String?  @map("device_hash")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  lastActivity DateTime @default(now()) @map("last_activity")
  video        Video    @relation("VideoToPlaybackSession", fields: [videoId], references: [id], onDelete: Cascade)

  @@index([cookieValue])
  @@index([expiresAt])
  @@index([videoId])
  @@map("playback_sessions")
}

model VideoRendition {
  id                      String         @id @default(cuid())
  videoId                 String         @map("video_id")
  name                    String
  walrusPlaylistUri       String         @map("walrus_playlist_uri")
  resolution              String
  bitrate                 Int
  playlistBlobObjectId    String?        @map("playlist_blob_object_id")
  playlistEndEpoch        Int?           @map("playlist_end_epoch")
  seal_playlist_blob_id   String?
  seal_playlist_object_id String?
  video                   Video          @relation("VideoToVideoRendition", fields: [videoId], references: [id], onDelete: Cascade)
  segments                VideoSegment[] @relation("VideoRenditionToVideoSegment")

  @@unique([videoId, name])
  @@index([playlistBlobObjectId])
  @@map("video_renditions")
}

model VideoSegment {
  id             String         @id @default(cuid())
  renditionId    String         @map("rendition_id")
  segIdx         Int            @map("seg_idx")
  walrusUri      String         @map("walrus_uri")
  iv             Bytes?
  duration       Float
  size           Int
  blobObjectId   String?        @map("blob_object_id")
  dekEnc         Bytes?         @map("dek_enc")
  endEpoch       Int?           @map("end_epoch")
  sealBlobId     String?        @map("seal_blob_id")
  sealDocumentId String?        @map("seal_document_id")
  rendition      VideoRendition @relation("VideoRenditionToVideoSegment", fields: [renditionId], references: [id], onDelete: Cascade)

  @@unique([renditionId, segIdx])
  @@index([renditionId])
  @@index([blobObjectId])
  @@map("video_segments")
}

model CreatorConfig {
  id           String   @id @default(cuid())
  videoId      String   @map("video_id")
  objectId     String   @map("object_id")
  chain        String
  coinType     String   @map("coin_type")
  pricePerView String   @map("price_per_view")
  decimals     Int
  metadata     String?
  createdAt    DateTime @default(now()) @map("created_at")
  video        Video    @relation("VideoToCreatorConfig", fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, coinType])
  @@index([videoId])
  @@index([objectId])
  @@index([chain])
  @@map("creator_configs")
}

model Video {
  id                  String            @id @default(cuid())
  title               String
  walrusMasterUri     String            @map("walrus_master_uri")
  posterWalrusUri     String?           @map("poster_walrus_uri")
  duration            Float?
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")
  creatorId           String            @map("creator_id")
  encryptionType      String            @default("per-video") @map("encryption_type")
  masterBlobObjectId  String?           @map("master_blob_object_id")
  masterEndEpoch      Int?              @map("master_end_epoch")
  network             String            @default("mainnet")
  posterBlobObjectId  String?           @map("poster_blob_object_id")
  posterEndEpoch      Int?              @map("poster_end_epoch")
  sealObjectId        String?           @map("seal_object_id")
  poster              String?
  seal_master_blob_id String?
  seal_poster_blob_id String?
  creatorConfigs      CreatorConfig[]   @relation("VideoToCreatorConfig")
  sessions            PlaybackSession[] @relation("VideoToPlaybackSession")
  renditions          VideoRendition[]  @relation("VideoToVideoRendition")
  likes               VideoLike[]       @relation("VideoToLikes")
  comments            VideoComment[]    @relation("VideoToComments")

  @@index([creatorId])
  @@index([masterBlobObjectId])
  @@index([masterEndEpoch])
  @@index([encryptionType])
  @@map("videos")
}

model VideoPaymentInfo {
  id                  String   @id @default(cuid())
  videoId             String   @map("video_id")
  payerAddress        String   @map("payer_address")
  chain               String   @map("chain")
  tunnelObjectId      String?  @map("tunnel_object_id")
  maxAllowedPayAmount String?  @map("max_allowed_pay_amount")
  currentPayAmount    String?  @map("current_pay_amount")
  authorizeSignature  String?  @map("authorize_signature")
  paidSegmentIds      Int[]    @map("paid_segment_ids")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([videoId])
  @@map("video_payment_infos")
}

model VideoLike {
  id        String   @id @default(cuid())
  videoId   String   @map("video_id")
  userId    String   @map("user_id") // Wallet address
  createdAt DateTime @default(now()) @map("created_at")
  video     Video    @relation("VideoToLikes", fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId])
  @@index([videoId])
  @@index([userId])
  @@map("video_likes")
}

model VideoComment {
  id         String   @id @default(cuid())
  videoId    String   @map("video_id")
  userId     String   @map("user_id") // Wallet address
  userName   String?  @map("user_name") // Optional creator name
  userAvatar String?  @map("user_avatar") // Optional avatar
  content    String   // Comment text
  createdAt  DateTime @default(now()) @map("created_at")
  video      Video    @relation("VideoToComments", fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([userId])
  @@map("video_comments")
}

model Creator {
  id              String         @id @default(cuid())
  walletAddress   String         @unique @map("wallet_address")
  name            String
  bio             String?
  avatar          String?
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  channelPrice    String?        @map("channel_price")
  channelChain    String?        @map("channel_chain")
  channelCoinType String?        @map("channel_coin_type")
  sealObjectId    String?        @map("seal_object_id")
  subscriptions   Subscription[] @relation("CreatorToSubscriptions")

  @@index([walletAddress])
  @@map("creators")
}

model Subscription {
  id                String   @id @default(cuid())
  subscriberAddress String   @map("subscriber_address")
  creatorId         String   @map("creator_id")
  chain             String
  txDigest          String   @map("tx_digest")
  createdAt         DateTime @default(now()) @map("created_at")
  creator           Creator  @relation("CreatorToSubscriptions", fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([subscriberAddress, creatorId, chain])
  @@index([creatorId])
  @@index([subscriberAddress])
  @@map("subscriptions")
}

model ImageContent {
  id             String               @id @default(cuid())
  title          String
  description    String?
  creatorId      String               @map("creator_id")
  network        String               @default("mainnet")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  creatorConfigs ImageCreatorConfig[] @relation("ImageContentToCreatorConfig")
  images         Image[]              @relation("ImageContentToImage")

  @@index([creatorId])
  @@index([createdAt])
  @@map("image_contents")
}

model Image {
  id           String       @id @default(cuid())
  contentId    String       @map("content_id")
  filename     String
  walrusUri    String       @map("walrus_uri")
  blobObjectId String?      @map("blob_object_id")
  endEpoch     Int?         @map("end_epoch")
  dekEnc       Bytes        @map("dek_enc")
  iv           Bytes
  size         Int
  mimeType     String       @map("mime_type")
  createdAt    DateTime     @default(now()) @map("created_at")
  content      ImageContent @relation("ImageContentToImage", fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([blobObjectId])
  @@map("images")
}

model ImageCreatorConfig {
  id           String       @id @default(cuid())
  contentId    String       @map("content_id")
  objectId     String       @map("object_id")
  chain        String
  coinType     String       @map("coin_type")
  pricePerView String       @map("price_per_view")
  decimals     Int
  metadata     String?
  createdAt    DateTime     @default(now()) @map("created_at")
  content      ImageContent @relation("ImageContentToCreatorConfig", fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, coinType])
  @@index([contentId])
  @@index([objectId])
  @@index([chain])
  @@map("image_creator_configs")
}

model TextContent {
  id             String              @id @default(cuid())
  title          String
  description    String?
  creatorId      String              @map("creator_id")
  network        String              @default("mainnet")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  creatorConfigs TextCreatorConfig[] @relation("TextContentToCreatorConfig")
  document       TextDocument?       @relation("TextContentToDocument")

  @@index([creatorId])
  @@index([createdAt])
  @@map("text_contents")
}

model TextDocument {
  id           String      @id @default(cuid())
  contentId    String      @unique @map("content_id")
  filename     String
  walrusUri    String      @map("walrus_uri")
  blobObjectId String?     @map("blob_object_id")
  endEpoch     Int?        @map("end_epoch")
  dekEnc       Bytes       @map("dek_enc")
  iv           Bytes
  size         Int
  mimeType     String      @map("mime_type")
  charCount    Int?        @map("char_count")
  wordCount    Int?        @map("word_count")
  createdAt    DateTime    @default(now()) @map("created_at")
  content      TextContent @relation("TextContentToDocument", fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([blobObjectId])
  @@map("text_documents")
}

model TextCreatorConfig {
  id           String      @id @default(cuid())
  contentId    String      @map("content_id")
  objectId     String      @map("object_id")
  chain        String
  coinType     String      @map("coin_type")
  pricePerView String      @map("price_per_view")
  decimals     Int
  metadata     String?
  createdAt    DateTime    @default(now()) @map("created_at")
  content      TextContent @relation("TextContentToCreatorConfig", fields: [contentId], references: [id], onDelete: Cascade)

  @@unique([contentId, coinType])
  @@index([contentId])
  @@index([objectId])
  @@index([chain])
  @@map("text_creator_configs")
}
